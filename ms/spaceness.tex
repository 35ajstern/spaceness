%\documentclass{article}
\newcommand{\beginsupplement}{%
        \setcounter{table}{0}
        \renewcommand{\thetable}{S\arabic{table}}%
        \setcounter{figure}{0}
        \renewcommand{\thefigure}{S\arabic{figure}}%
     }
\newcommand{\stopsupplement}{%
        \setcounter{table}{0}
        \renewcommand{\thetable}{\arabic{table}}%
        \setcounter{figure}{0}
        \renewcommand{\thefigure}{\arabic{figure}}%
     }

\documentclass[9pt,twocolumn,twoside,lineno]{gsajnl}
\usepackage{amsmath}
% Use the documentclass option 'lineno' to view line numbers

\articletype{preprint} % article type
% {inv} Investigation 
% {gs} Genomic Selection
% {goi} Genetics of Immunity 
% {gos} Genetics of Sex 
% {mp} Multiparental Populations

% adding commenting commands
\newif\ifcomments
\commentstrue
%\commentsfalse
\newcommand{\cjb}[1]{\ifcomments{{\color{blue} \it (#1)}}\else{}\fi}
\newcommand{\plr}[1]{\ifcomments{{\color{purple} \it (#1)}}\else{}\fi}
\newcommand{\ak}[1]{\ifcomments{{\color{red} \it (#1)}}\else{}\fi}


%Simulating Isolation by Distance in Continuous Space
%Space is the Place: How Dispersal and Competition Shape Genetic Variation in Continuous Space
%Impacts of Continuous Spatial Structure on Analyses of Population Genetic Data
%Impacts of Isolation by Distance on Demographic Modeling and Association Studies
%Impacts of Dispersal and Sampling on Estimates of Genetic Variation in Continuous Space
%Space is the Place: How Dispersal and Sampling Shape Estimates of Genetic Variation in Continuous Space
\title{Space is the Place: How Dispersal and Sampling Shape Analyses of Genetic Variation in Continuous Space}

\author[$\ast$,1]{C.J. Battey}
\author[$\ast$]{Peter Ralph}
\author[$\ast$]{Andrew Kern}

\affil[$\ast$]{University of Oregon Dept. Biology, Institute for Ecology Evolution}
\keywords{Space; Population Structure; Demography; Haplotype block sharing}

\runningtitle{SPACENESS} % For use in the footer 

%% For the footnote.
%% Give the last name of the first author if only one author;
% \runningauthor{FirstAuthorLastname}
%% last names of both authors if there are two authors;
% \runningauthor{FirstAuthorLastname and SecondAuthorLastname}
%% last name of the first author followed by et al, if more than two authors.
\runningauthor{Battey \textit{et al.}}

\begin{abstract}
Individuals exist in continuous space, but standard models in population genetics are based on discrete randomly-mating populations exchanging migrants. Here we implement a forward-time simulation of evolution in continuous space and use it to study the impacts of dispersal and sampling strategy on population genetic summary statistics, demographic inference, and association studies. Low dispersal slows the geographic spread of ancestry and increases branch lengths corresponding to mid-frequency alleles because of slow coalescence among distant groups of individuals. As a result demographic inference from the site frequency spectrum is biased towards inferring a turbulent past demographic history and a recent decline in populations when neighborhood sizes are below 20. For many common population genetic summary statistics the variation associated with different sampling strategies is larger than that observed across the range of dispersal distances we simulated, pointing to the need to carefully account for the spatial distribution of sampling when interpreting results. Last we show that spatially correlated environments cause genome-wide signals of association with purely environmental phenotypes in linear-regression GWAS, and that this bias is not fully controlled by regressing out principal components positions during the analysis.  
\end{abstract}

\begin{document}

\maketitle
\thispagestyle{firststyle}
\marginmark
\firstpagefootnote


\correspondingauthoraffiliation{1}{301 Pacific Hall, University of Oregon Dept. Biology, Institute for Ecology and Evolution. cbattey2@uoregon.edu.}
\vspace{-35pt}% Only used for adjusting extra space in the left column of the first page

\section{Introduction}
The inescapable reality that biological organisms live, move, and reproduce in continuous spatial landscapes has been all but ignored in population genetic models. Indeed a near universal rule of reproduction is that individuals mate with other nearby individuals, leading to a positive correlation between genetic and geographic distances. This pattern of "isolation by distance" \citep{Wright1943} is one of the most widely replicated empirical findings in population genetics \citep{Chen2017,Jay2012,Sharbel2000}, but our mathematical models to describe it are poor approximations of the underlying process. As the availability of population-level, whole-genome data allows inference of increasingly fine-scale patterns of ancestry in many species, models incorporating biologically realistic demographic and spatial processes are needed to accurately describe continuous spatial structure and control for its impacts on analyses of selection and demography. This situation is particularly clear in human population genetics, where individual ancestries are often interpreted as mixtures of discrete populations in part because of modeling assumptions underlying discrete clustering algorithms and association analyses are often strongly dependent on statistical corrections for population stratification \citep{Berg2018,Bulik-Sullivan2015,Young2018,Heckerman2016,Kang2010,Sohail2018}.  

The best-studied approaches to population genetics in continuous space were developed by \citep{Wright1943} and \citep{Malecot1948}, who derived expressions for genetic differentiation in continuous space assuming Poisson distributed numbers of offspring and independent dispersal among individuals. A key finding of Wright's model is that many important aspects of continuous populations can be described in terms of "neighborhood size" -- the number of potential mates for an individual in a given generation, defined as $4\pi\sigma^2d$, where $\sigma$ is the average dispersal distance and $d$ is population density. \cite{Maruyama1972} found that the rate of decline in genetic diversity in a 2-dimensional continuous population approaches the random mating expectation when $D\sigma^2 > 1$, and proposed that this had the important implication that most population genetic expectations for randomly mating populations could be applied to continuously distributed populations with relatively little error. 

Though some aspects of continuous populations are fairly well described by the Wright-Malécot models, \cite{Felsenstein1975} showed that the assumptions of independent dispersal and Poisson distributed offspring that are the basis of these models are incompatible. Over time, a population meeting them will clump into a small number of geographic clusters occupying only a part of the available range. Although real populations are often clumped on landscapes due to factors like varying habitat quality and competition among species, the Wright and Malécot models produce much more extreme clumping than is observed in practice and fail to account for the density-dependent declines in population growth rate that are widely observed in real populations (CITE). 

One method for modeling continuous populations is then to assume the existence of a grid of discrete randomly-mating populations connected by migration, which prevents clustering by forcing all regions to be occupied in every generation. Among many other important results drawn from this class of "lattice" or "stepping stone" models, \cite{Rousset1997} showed that the slope of the a linear regression of genetic differentiation ($F_{st}$) against the logarithm of spatial distance is an estimate of neighborhood size. Though good approximations of continuous structure given high dispersal (Barton(?)), these models are not truly continuous, force a uniform realized population density across landscapes, and limit investigation of spatial structure below the level of the deme. An alternative method is to model the geographic spread of ancestry backwards in time through a diffusion approximation -- an approach that has recently made significant progress in modeling both dispersal and demographic parameters \citep{Barton2010,Kelleher2014,Ringbauer2017,Ringbauer2018}. However these models currently lack a well-described forward-time analog that produces biologically realistic spatial patterns and are subject to the same difficulty in incorporating selection and other biological processes as all other reverse time methods (CITE??).

\ak{Andy-- I think we could move some of the text from the following paragraph to methods}
We took a direct approach to the clustering problem of classical forward-time models by incorporating density dependence into the model. By scaling the probability of survival in each timestep to local population density we shift reproductive output towards regions of low-density and prevent populations from clustering. A similar approach was taken previously by \citep{Doebeli2003} who used an individual based model with continuous space and density dependent fitness to study the probability of speciation along continuous environmental gradients. However to our knowledge all previous implementations of continuous space models have focused on a small number of genetic loci as the unit of analysis, which limits the ability to investigate the impacts of continuous space on genome-wide genetic variation as is now routinely sampled from real organisms. 

Here we describe an implementation of an individual-based model in continuous space that incorporates overlapping generations, a Gaussian dispersal kernel, and density-dependent fitness. The model scales to chromosome-scale alignments across tens of thousands of individuals, and outputs the full genealogy and recombination history of all final-generation individuals. We use this simulation to describe how sampling strategy interacts with isolation by distance to cause systematic variation in population genetic summary statistics typically analyzed under discrete population models. We then examine how the fine-scale spatial structures occurring under limited dispersal impact demographic inference from the site frequency spectrum; finding that inflation of branch lengths for mid-frequency alleles associated with slow coalescence of distant individuals can bias analyses towards inferring turbulent demographic histories and recent declines in population size. 

Last, we use our model to study the impacts of isolation by distance in continuous space on genome-wide association studies (GWAS). Variation in ancestry proportions between case and control cohorts is expected to cause inflation of test statistics at SNPs with different allele frequencies among populations \citep{Price2006}. Because most phenotypes are influenced by the environment and environmental factors are often spatially correlated, subtle spatial structure within continuous populations can also deflate $p$ values in GWAS of quantitative traits \citep{Mathieson2012}. These issues are particularly prominent for polygenic traits, because the deflated $p$ values expected from polygenic phenotype correlations are superficially similar to those expected from population structure \citep{Bulik-Sullivan2015,Young2018}. However most studies examining the effects of stratification on GWAS have focused on simulating phenotypes for real genotype data \citep{Price2006,Bulik-Sullivan2015} or generating simulated genotypes by sampling from static allele frequency distributions \citep{Bulik-Sullivan2015,Heckerman2016}. These approaches address application to human data but are not based on a true generative model and so provide limited insight into the processes generating stratification bias in association analyses. Here we simulate both the underlying genealogy and phenotypes of a continuously distributed population and seek to identify regions of parameter space -- i.e. the strength of isolation by distance and the spatial distribution of environmental effects on phenotypes -- in which common methods of stratification bias corrections in GWAS are subject to bias. 

%[move some of this to methods, rewrite to avoid repitition w above]  A common method of correcting for population structure in GWAS is to run a principal components analysis on the genotype matrix and include PC coordinates as covariates in a linear regression for each SNP \citep{Price2006}. Mixed model GWAS employs a different statistical framework but takes a similar approach by incorporating a kinship matrix describing pairwise genetic relatedness among samples as a random effect in a linear mixed model \citep{Yu2006,Kang2008}. In both approaches the key question is whether or not the ancestry components of the model adequately describe "background" levels of genetic variation in the sample relative to any confounding effects of ancestry and phenotype. Recent studies in European and British populations \citep{Kerminen2018,Berg2018,Sohail2018} have found evidence of residual population stratification in effect size estimates from large-scale GWAS employing both linear and mixed model approaches, suggesting that existing structure corrections may be inadequate. For traits controlled by a few large effect loci this confounding effect is likely to be relatively small, but for analyses of complex traits with thousands of putatively associated SNPs the potential for confounding is high. Here we simulate a range of spatially correlated phenotypes for simulated individuals and seek to identify conditions under which existing GWAS structure corrections are subject to bias caused by continuous population structure.  

\section{Materials and Methods}
\label{sec:materials:methods}

\subsection{A Forward-Time Model of Evolution in Continuous Space}

We implemented our model using the non-Wright-Fisher module in the program SLiM v3.0 \citep{Haller2019}. Each time step consists of three stages: reproduction, dispersal, and competition. To reduce the parameter space we use the same parameter, denoted $\sigma$, to modulate the spatial scale of interactions at all three stages by adjusting the standard deviation of the corresponding Gaussian functions. As in previous work \citep{Wright1943,Ringbauer2017}, $\sigma$ as applied in our dispersal step is approximately equal to the mean parent-offspring distance.  

At the beginning of the simulation individuals are distributed randomly on a continuous landscape. Mates are selected proportional to distances among individuals weighted by a Gaussian function with mean $1/(2\pi\sigma^2)$ and standard deviation $\sigma$. Wright's \cite{Wright1943} "Neighborhood Size", defined as $4\pi\sigma^2 K$ where $K$ is the population density, is then the approximate number of individuals available for mating in our simulation. The number of offspring is drawn from a Poisson distribution with mean $1/L$, where $L$ is the average lifespan. If new offspring are produced, we simulate dispersal by taking two draws from a normal distribution with mean 0 and standard deviation $\sigma$ and adding these to the x and y coordinates of the first parent. 

Density-dependent competition is simulated by adjusting the probability of survival of each individual proportional to the local density of individuals up to a distance $3\sigma$ away, scaled according to the same Gaussian function used for mate selection. Given a per-unit carrying capacity $K$ and average fecundity $F$, the probability of survival $d$ for individual $i$ after adjustment for density is:

\begin{equation}
    d_{i}=min(0.95,\frac{1}{1+\rho*\sum_{i}{G(x)}})
\end{equation}
where 
\begin{equation}
    \rho = F/((1+F)*K)
\end{equation} 
and $G(x)$ is the Gaussian function used to weight distances to other individuals. 

A major challenge in all spatial models is dealing with range edges. When local population density is used to model competition, edge or corner populations can be assigned artificially high fitness values because they lack neighbors within their interaction radius but outside the bounds of the simulation. We approximate a decline in habitat suitability near edges by decreasing the probability of survival proportional to the square root of distance to edges in units of $\sigma$. The final probability of survival for individuals within one $\sigma$ of an edge is 

\begin{multline}
    s_{i}=d_{i} min(1,\sqrt{x_{i}/\sigma})
    min(1,\sqrt{y_{i}/\sigma})\\
    min(1,\sqrt{(x_{max}-x_{i})/\sigma})
    min(1,\sqrt{(y_{max}-y_{i})/\sigma)}
\end{multline}

where $x$ and $y$ are spatial coordinates. 

To isolate spatial effects from other components of the model such as overlapping generations, increased variance in reproductive success, and density-dependent fitness, we  also implemented a second version of the SLiM simulation in which mates are selected at random and offspring disperse to a random location on the landscape. For all simulations the full genealogy and recombination history of final-generation individuals were stored as tree sequences \citep{Kelleher2018}. 

%We compared our model output to a two-dimensional stepping-stone model and a one-population coalescent model implemented in msprime \citep{Kelleher2016}. To isolate spatial effects from other components of the model such as overlapping generations and density-dependent probability of survival, we also ran a second version of the SLiM model with random mate selection and dispersal. 

We ran 400 simulations for the spatial and random-mating SLiM models on a square landscape of size 50 with per-unit carrying capacity $K=5$ (census $N \approx 10,000$), average lifetime $L=4$, genome size $1\times10^{8}$, recombination rate $1\times10^{-9}$, and drawing $/sigma$ values from a uniform distribution bounded by 0.2 and 4. To speed up the simulations and limit memory overhead we used a mutation rate of 0 in SLiM and later applied mutations to the coalesced tree sequence with msprime's 'mutate( )' function. Because msprime assumes that timesteps are in units of generations, we divided the per-generation rate of $1\times10^{-8} mut/site/gen$ by the generation time estimated for each value of $\sigma$ (see 'Genealogical Parameters' below) to convert the rate to units of mutations/site/timestep. We then verified that this procedure produced the correct number of mutations by comparing a subset of simulations with SLiM-generated mutations (which are applied only at mating events) with mutations added by msprime (Supplementary Figure 1). Simulations were run for 1.6 million timesteps (approximately 30N generations), or until all extant individuals shared a common ancestor within the simulation (i.e. the tree sequence had coalesced). 

%Coalescent stepping-stone simulations were on a 5x5 grid with 10 haploid samples per deme and migration between adjacent populations. To facilitate comparison across simulation types we ran one coalescent simulation for every SLiM parameter set. Because $\sigma$ is approximately equal to the mean distance between parent and offspring, we approximate the relationship between $\sigma$ and the migration rate in a grid simulation as $\sigma=4md$, where $m$ is the migration rate and $d$ is the ratio of landscape widths in continuous space vs coalescent simulations (here, 10). That is, an individual in an interior population has a $4m$ probability of being a migrant, and if it is a migrant will move $d$ units on the map. We set the total $N_{e}$ equal to the census size of each SLiM simulation divided by the variance in reproductive output (see below). 

\subsection{Genealogical Parameters}
To study the geographic spread of genealogical ancestry in our simulations we output the full pedigree of all individuals over 50 generations with $\sigma$ set to 0.2, 0.35, 0.5, 1, 2, and 3.5 (corresponding to Wright's Neighborhood Sizes of 2.5, 7.7, 15.7, 62.8, 251.3, and 769.7, respectively). We then selected the individual closest to the center of the landscape in the final generation of each simulation, pruned the pedigree to include only its genealogical ancestors (that is, regardless of the amount of genetic material actually inherited from a given ancestor) and plotted the age of its most recent ancestor in each region of the full landscape using the 2-dimensional summary feature of ggplot2 in R \citep{Wickham2016}. We calculated the rate of spread of genealogical ancestry by estimating the mean and maximum distances between the focal individual and its ancestors in each generation and then fitting a linear model for distance as a function of generations using ordinary least squares regression. 

We also estimated the variance in offspring and generation time for all simulations. To estimate generation times we stored the age of all parents for 200 timesteps and took the mean. To estimate variance in offspring we output the complete pedigree of all individuals in SLiM, counted the number of offspring for all individuals born in timesteps 50-150 (to ensure that the simulation captured the full lifespan of the sampled individuals), and calculated the variance. 

\subsection{Sampling}
Our model records the genealogy and sequence variation of the complete population, but in real data genotypes are only observed from a a relatively small number of sampled individuals. We modeled three sampling strategies similar to common data collection methods in empirical genetic studies (Figure 1). "Random" sampling selects individuals at random from across the full landscape, "point" sampling selects individuals proportional to their distance from four equally spaced points on the landscape, and "midpoint" sampling selects individuals in proportion to their distance from the middle of the landscape. Downtream analyses were repeated across all sampling strategies. 

\subsection{Summary Statistics}
We calculated the site frequency spectrum and a set of 18 summary statistics (Supplementary Table 1) from 60 diploid individuals sampled from the final generation of each simulation using the python package scikit-allel \citep{Miles2017}. Statistics included common single-population summaries including mean pairwise divergence ($\pi$), inbreeding coefficient ($F_{is}$), and Tajima's D, as well as the classic isolation-by-distance regression of genetic distance ($D_{xy}$) against the logarithm of geographic distances \citep{Rousset1997}, which we summarized as the correlation coefficient between $log10(spatial distance)$ and the proportion of identical base pairs among individuals. 

Following recent studies that showed strong signals for dispersal and demography in the distribution of shared haplotype block lengths \citep{Ringbauer2017,Baharian2016}, we also calculated various summaries of the distribution of pairwise identical-by-state (IBS) block lengths among samples. The full distribution of lengths of IBS tracts for each pair of individuals was first calculated with a custom python function. We then calculated the first three moments of this distribution (mean, variance, and skew) and the number of blocks over $1e6$ base pairs both for each pair of individuals and for the full distribution across all pairwise comparisons. 

We then estimated correlation coefficients between spatial distance and each moment of the pairwise IBS tract distribution. Because more closely related individuals on average share longer haplotype blocks we expect that spatial distance will be negatively correlated with mean haplotype block length, and that this correlation will be strongest (i.e. most negative) when dispersal is low. The variance, skew, and count of long haplotype block statistics are meant to reflect the relative length of the right (upper) tail of the distribution, which represents the frequency of long haplotype blocks so should reflect recent demographic events \citep{Ringbauer2017}. 

The effects of sampling on summary statistic estimates were summarized by testing for differences in mean (ANOVA, \citep{Rcore2018}) and variance (Levene's test, \citep{Fox2011}) across sampling strategies for each summary statistic. 

\subsection{Demographic Modeling}
We fit single-population demographic models to the site frequency spectra of 20 individuals from each spatial SLiM simulation with the program Stairwayplot \citep{Liu2015}. This analysis was replicated across random, point, and midpoint sampling strategies. Site frequency spectra used for input data were calculated in scikit-allel \citep{Miles2017}, and 100 bootstrap replicates were generated for each simulation by resampling over sites. Models were fit across all bootstrap replicates using default settings in Stairwayplot and the median estimate of $Ne$ per generation was used to represent the output of each simulation.

\subsection{Association Studies}
To assess the degree to which spatial structure confounds GWAS we simulated four types of nongenetic phenotype variation for 1000 randomly sampled individuals in each spatial SLiM simulation and conducted a linear-regression GWAS with PC covariates in PLINK \citep{PURCELL2007}. SNPs with a minor allele frequency less than 0.5\% were excluded from this analysis. Phenotype values were meant to roughly reflect the distribution of height across Europe, which has recently been found to be confounded with population structure in large scale GWAS \citep{Berg2018,Sohail2018}. Conceptually our approach is similar to that taken in \citep{Mathieson2012}, though here we model fully continuous spatial variation and focus on genome-wide effects rather than low-frequency alleles specifically. 

In the first simulation phenotypes for all individuals were drawn from a normal distribution with mean 110 and standard deviation 10. Next we simulated clinal environmental influences on phenotype by drawing the phenotypes from independent normal distributions in which the mean was scaled by an individual's x position such that it varied by 2 standard deviations across the map. Third, we approximate concentrated environmental effects by drawing phenotypes for individuals with x and y coordinates below 20 from a normal distribution with mean 2 standard deviations above the rest of the map. Last, we simulated a "patchy" environmental influence on phenotypes by selecting 10 random points on the map and drawing phenotypes for all individuals within two map units of any selected point from a normal distribution with mean 2 standard deviations above the rest of the map. 

Principal components analysis (PCA) was conducted in scikit allel on the matrix of derived allele counts by individual for each simulation. SNPs were first filtered to remove strongly linked sites by calculating LD between all pairs of SNPs in a 200-SNP moving window and dropping one of each pair of sites with an $R^2$ over 0.1. The LD-pruned allele count matrix was then centered and all sites scaled to unit variance when conducting the PCA, following recommendations in \citep{Patterson2006}.   

We ran linear-model GWAS both with and without the first 10 principal components as covariates in PLINK and summarized results across simulations by counting the number of significant SNPs with an expected false positive rate of less than 5\% after adjusting p values with the R function p.adjust(...,method="fdr"). We also examined $p$ values for systemic inflation by estimating the expected values from a uniform distribution (because no SNPs were used when generating phenotypes), plotting observed against expected values for all simulations, and summarizing across simulations by finding the mean $\sigma$ value in each region of quantile-quantile space. Results from all analyses were summarized and plotted with the 'ggplot2' \citep{Wickham2016} and "cowplot" \citep{Wilke2019} packages in R \citep{Rcore2018}. 

\section{Results}

\subsection{Genealogical Parameters and Run Times}
\subsection{Impacts of Sampling on Summary Statistics}
For spatial models the mean and variance of all summary statistics other than those involving the mean of the IBS block size distribution was significantly different across sampling strategies (Supplementary Table 1). Means were not significantly different across sampling strategies for any statistic under the random mating model. Only spatial correlation coefficients had significantly different variance under the random mating model, though in all cases the mean correlation was near zero.

\subsubsection{Diversity and Site Frequency Spectra}
Mean within-population genetic distance ($\pi$), the inbreeding coefficient ($F_{is}$) and Tajima's $D$ are inflated at low dispersal distances (Figure 2). $\pi$ and $F_{is}$ approach the random mating model at neighborhood sizes of roughly 100. Tajima's D varies relatively more across sampling strategies; approaching random mating at $NS\approx65$ with random sampling and $NS>1000$ with midpoint sampling.

The inflation in $F_{is}$ appears to be caused by a deficit of heterozygous individuals in low-dispersal simulations -- a continuous-space version of the Wahlund effect \citep{Wahlund1928}. However under midpoint sampling observed heterozygosity is inflated over the random mating expectation, which we confirmed is caused by a higher proportion of heterozygotes in the middle of the landscape (Supplementary Figure S2 \cjb{CJ - this fig isn't super convincing -- will try denser sampling}). \cite{Shirk2014} observed a similar excess of heterozygosity in the middle of the landscape when simulating under a lattice model. 

The site frequency spectrum showed minimal differences across sampling strategies for random mating models (Supplementary Figure S1). Spatial models had fewer low frequency alleles and more mid-frequency alleles than random mating models (Figure 2). This effect is relatively weak when sampling is random and strongest for midpoint sampling. 

\subsubsection{Haplotype Block Lengths}
Trends in pairwise haplotype block sharing parallel those in SNP-based diversity estimates. At low dispersal the distribution of IBS block lengths in a set of samples is shifted towards smaller values -- resulting in lower means and fewer long IBS blocks. The variance and skew of the full IBS tract distribution vary across sampling strategies, but are similar to random-mating models under random sampling. 

\subsubsection{Spatial Correlations}
The correlation coefficient between spatial distance and pairwise genetic differentiation ($D_{xy}$) is positive and declines as dispersal increases, as expected under the theory developed by \citep{Rousset1997} and others. As in \citep{Ringbauer2017} and \citep{Baharian2016} we found that the pairwise distribution of haplotype block lengths is more strongly left-skewed under limited dispersal. This is reflected in negative correlation coefficients between spatial distance and the mean, variance, skew, and count of long blocks from the pairwise distribution of identical-by-state block lengths. Of these summaries the mean of the IBS tract length distribution has very weak sigmal for $\sigma$, likely because it is heavily influenced by the small number of very long IBS tracts. Though the count of long IBS blocks and the skew of the full distribution are low and similar to random mating when taken across all samples, the correlation coefficients between spatial distance and the skew or count of long IBS blocks on a pairwise basis varies predictably by neighborhood size. All spatial correlations approach the random mating model near neighborhood sizes of 1000 under either point or random sampling. Midpoint sampling causes weaker correlations in all sampling schemes. 

\subsection{Demographic Modeling}
Demographic models from Stairwayplot tended to infer patterns of ancient population increases and recent declines when neighborhood sizes were low under all sampling strategies (Figure 3). Inflated past population sizes were common in both point and random sampling, demonstrating that the relatively minor shift in the site frequency spectrum observed with random sampling is enough to alter demographic estimates. Inference of severe population bottlenecks was also common across neighborhood sizes, particularly under midpoint and point sampling. Across all sampling schemes and neighborhood sizes around 20\% of runs inferred a sharp increase in population in the last 100 years.

Estimates stabilize for all sampling schemes as neighborhood sizes approach 750, and trend towards roughly half the census size. 
\cjb{I still need to figure out what's going on with Ne here... pi is $\approx$ expected value for a WF population with $N\approx N_{c}/2$, but variance Ne is more like 1/5 census N. I thought it was closer to 1/2 earlier because of a bug in my script where I was dropping individuals who had 0 offspring. Working on it...}. 


\subsection{GWAS}
Spatially correlated phenotypes in populations with low neighborhood size cause uncorrected linear-regression GWAS to report significant associations at most genome-wide SNPs (Figure 1). When PCA positions are included as covariates the vast majority of SNPs no longer pass a 5\% FDR significance threshold, but up to 1000 genome-wide significant hits (out of an average of 132,000 SNPs) were observed even in relatively high dispersal simulations for the corner and clinal distributions. Corner and patchy phenotype distributions produced the largest number of significant SNPs, and patchy phenotypes in particular showed little difference in the count of significant SNPs after PC correction.

For clinal phenotypes PCA covariates perform well in correcting for population stratification at low dispersal distances but the correction breaks down above neighborhood sizes of $\approx250$. This pattern appears to reflect a loss of descriptive power in the first ten axes of the PCA, which describe less of the total variation in the data as neighborhood size increases (Figure 4). 

Quantile-quantile plots show that $p$ value deflation is most pronounced for the corner phenotype distribution and is particularly strong for simulations with neighborhood sizes of less than 20. Quantile-quantile plots of clinal and nonspatial phenotypes also show evidence of $p$ value $inflation$ (i.e. points below the 1:1 line), which is observed only when PCA covariates are included in the analysis (see Supplementary Figure X for plots of uncorrected GWAS results). 

\section{Discussion}

\subsection{GWAS}

% As in \citep{Mathieson2012} we observed that the deflation in $p$ values after PCA correction is largest for spatially discrete phenotypes, and is weaker for phenotypes that are clinal over space. When dispersal is low and isolation by distance is strong this effect is pronounced enough to create statistically significant associations at nearly every variable site in the genome unless statistical corrections for population structure are implemented. For strongly structure populations and phenotypes that vary systematically over space, the estimated effect sizes and biological interpretations of linear-regression GWAS are therefore controlled primarily by the method of stratification control rather than underlying causal associations between phenotype and genotype. 

%This is unlikely to be a significant issue for studies seeking to identify a small number of causal alleles as long as there is variation within populations at those sites. However analyses of putatively polygenic phenotypes may be badly affected both by deflation of $p$ values from uncontrolled stratification and by inflation of $p$ values caused by the use of PCA covariates. Though many studies now employ mixed-model methods \citep{Kang2008,Yu2006,Kang2010} which are likely more robust to stratification (though not immune, see \citep{Berg2018}), using principal components regression as the method of stratification control is still common in analyses of human genetics [quality time w nature genetics]. 

\section{Data Availability}

\section{Acknowledgements}
\newpage

\begin{figure}[htbp]
\includegraphics{sampling_maps.pdf}
\caption{Example sampling maps for 60 individuals on a 50x50 landscape under midpoint, point, and random sampling strategies.}
\label{fig:spectrum}
\end{figure}

\begin{figure*}[htbp]
\centering
\includegraphics[width=\textwidth]{pop_params.pdf}
\caption{Genealogical parameters from spatial and random mating SLiM simulations, by neighborhood size.}
\label{fig:spectrum}
\end{figure*}


\begin{figure*}[p]
\centering
\includegraphics[width=\textwidth]{sfs_w_sumstats.pdf}
\caption{A: Site frequency spectra when sampling individuals from the midpoint, from four equally spaced points, and randomly across the landscape. Random mating models showed no differences by sampling scheme -- see supplementary figure S1. Spatial models have fewer low-frequency alleles and more mid-frequency alleles when neighborhood sizes are small, and this effect is stronger when sampling is more concentrated. B: Summary statistics under different sampling strategies, by neighborhood size.}
\label{fig:spectrum}
\end{figure*}

\afterpage{\clearpage}
\begin{figure*}[p]
\centering
\includegraphics[width=\textwidth]{stairwayplot_by_sigma_facet_sampling_by_bin.pdf}
\caption{Inferred demographic histories for spatial SLiM simulations from Stairwayplot by sampling scheme and neighborhood size (NS) range. Lines shown are the median inferred $N_{e}$ across 100 bootstrap replicates for each simulation. Colors are scaled to Wright's neighborhood size. The solid black line is the average census population size, and the dotted line is the average variance effective size ($N_{c}/var(n offspring)$).}
\label{fig:spectrum}
\end{figure*}

\afterpage{\clearpage}
\begin{figure*}[p]
\centering
\includegraphics[width=\textwidth]{gwas_summary_nsig_qqplots_loglog.pdf}
\caption{Impacts of spatially correlated phenotypes and isolation by distance on linear regression GWAS.  A: example phenotype distributions and sampling maps, with colors scaled to phenotype values. B: proportion of total variance explained by the first 10 PC axes, by neighborhood size. C: numbers of significant SNPs after FDR correction for linear-model GWAS conducted with (top) or without (bottom) PC covariates. D: Quantile-quantile plots of observed $p$ values relative to those expected from a uniform distribution. The dotted lines show the 95\% confidence region assuming binomial sampling and an alpha level of 0.05. Points above the 1:1 line reflect deflated $p$ values.}
\label{fig:spectrum}
\end{figure*}

\afterpage{\clearpage}

\bibliography{spaceness}

\section{Supplementary Figures and Tables}
\beginsupplement

\afterpage{\clearpage}
\begin{figure*}[p]
\centering
\includegraphics[width=\textwidth]{sumstats_by_neighbors_allstats.pdf}
\caption{Change in summary statistics by neighborhood size and sampling scheme calculated from simulated sequence data of 60 individuals.}
\label{fig:spectrum} 
\end{figure*}


\afterpage{\clearpage}
\begin{figure*}[p]
\centering
\includegraphics[width=\textwidth]{fig_S1_sfs_grid_model_by_sampling.pdf}
\caption{Site frequency spectra for random mating and spatial SLiM models under all sampling schemes.}
\label{fig:spectrum}
\end{figure*}

\afterpage{\clearpage}
\begin{figure*}[p]
\centering
\includegraphics[]{het_z_by_ind.pdf}
\caption{Normalized mean observed heterozygosity by location across 200 randomly-sampled individuals}
\label{fig:spectrum}
\end{figure*}

%\afterpage{\clearpage}
%\begin{figure*}[p]
%\centering
%\includegraphics[width=\textwidth]{stairwayplot_by_sigma_facet_sampling_by_bin.pdf}
%\caption{Inferred demographic histories for spatial SLiM simulations from Stairwayplot by %sampling scheme and neighborhood size (NS) range. Lines shown are the median inferred %$N_{e}$ across 100 bootstrap replicates for each simulation. Colors are scaled to Wright's %neighborhood size. The solid black line is the average census population size, and the %dotted line is the average variance effective size ($N_{e}/var(n offspring)$).}
%\label{fig:spectrum}
%\end{figure*}

\begin{table*}[htbp]
\centering
\caption{\bf Anova and Levene's test $p$ values for differences by sampling strategy. Bolded values are rejected at \alpha=0.05}
\begin{tableminipage}{\textwidth}
\begin{tabularx}{\textwidth}{XXXX}
  \hline
 variable & model & p(equal means) & p(equal variance) \\ 
  \hline
segsites & random mating & 0.998190 & 0.980730 \\ 
pi & random mating & 0.997750 & 0.996450 \\ 
thetaW & random mating & 0.998190 & 0.980730 \\ 
tajD & random mating & 0.879690 & 0.188770 \\ 
het\_o & random mating & 0.531540 & 0.433230 \\ 
fis & random mating & 0.474790 & 0.785730 \\ 
gen\_dist\_mean & random mating & 0.997770 & 0.996510 \\ 
gen\_dist\_var & random mating & 0.283630 & 0.647240 \\ 
gen\_dist\_skew & random mating & 0.958320 & 0.260750 \\ 
gen\_sp\_corr & random mating & 0.601980 &\textbf{0.000000} \\ 
ibs\_mean & random mating & 0.997960 & 0.997730 \\ 
ibs\_var & random mating & 0.486450 & 0.399490 \\ 
ibs\_skew & random mating & 0.117980 & 0.069770 \\ 
ibs\_blocks\_per\_pair & random mating & 0.997680 & 0.996570 \\ 
ibs\_blocks\_over\_1e6\_per\_pair & random mating & 0.834870 & 0.888730 \\ 
ibs\_mean\_spat\_corr & random mating & 0.073270 & 0.308420 \\ 
ibs\_1e6blocks\_spat\_corr & random mating & 0.268440 & \textbf{0.002100} \\ 
ibs\_skew\_spat\_corr & random mating & 0.396920 & \textbf{0.000620} \\ 
ibs\_blocks\_spat\_corr & random mating & 0.581090 & \textbf{0.000000} \\ 
segsites & spatial & \textbf{0.000000} & \textbf{0.000000} \\ 
pi & spatial & \textbf{0.026510} & \textbf{0.013440} \\ 
thetaW & spatial & \textbf{0.000000} & \textbf{0.000000} \\ 
tajD & spatial & \textbf{0.000000} & \textbf{0.000000} \\ 
het\_o & spatial & \textbf{0.000000} & \textbf{0.000000} \\ 
fis & spatial & \textbf{0.000000} & \textbf{0.000120} \\ 
gen\_dist\_mean & spatial & \textbf{0.025390} & \textbf{0.012910} \\ 
gen\_dist\_var & spatial & \textbf{0.004970} & \textbf{0.006230} \\ 
gen\_dist\_skew & spatial & \textbf{0.000000} & \textbf{0.000000} \\ 
gen\_sp\_corr & spatial & \textbf{0.000000} & \textbf{0.000000} \\ 
ibs\_mean & spatial & 0.272400 & 0.114250 \\ 
ibs\_var & spatial & \textbf{0.000000} & \textbf{0.000000} \\ 
ibs\_skew & spatial & \textbf{0.000000} & \textbf{0.000000} \\ 
ibs\_blocks\_per\_pair & spatial & \textbf{0.033920} & \textbf{0.016640} \\ 
ibs\_blocks\_over\_1e6\_per\_pair & spatial & \textbf{0.000000} & \textbf{0.000000} \\ 
ibs\_mean\_spat\_corr & spatial & \textbf{0.000000} & 0.590540 \\ 
ibs\_1e6blocks\_spat\_corr & spatial & \textbf{0.000000} & \textbf{0.000000} \\ 
ibs\_skew\_spat\_corr & spatial & \textbf{0.000000} & \textbf{0.000000} \\ 
ibs\_blocks\_spat\_corr & spatial & \textbf{0.000000} & \textbf{0.000000} \\ 
\hline
\end{tabularx}
\end{tableminipage}

\end{table*}

\endsupplement



\end{document}







%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\section{Genetics Submission Guidelines}
Manuscripts submitted to \textit{GENETICS} should contain a clear description of the experimental design in sufficient detail so that the experimental analysis could be repeated by another scientist. If the level of detail necessary to explain the protocol goes beyond two paragraphs, give a short description in the main body of the paper and prepare a detailed description for supporting information.  For example, details would include indicating how many individuals were used, and if applicable how individuals or groups were combined for analysis. If working with mutants indicate how many independent mutants were isolated. If working with populations indicate how samples were collected and whether they were random with respect to the target population.


\subsection{Statistical Analysis} 

It is important to indicate what statistical analysis has been performed; not just the name of the software and options selected, but the method and model applied. In the case of many genes being examined simultaneously, or many phenotypes, a multiple comparison correction should be used to control the type I error rate, or a rationale for not applying a correction must be provided. The type of correction applied should be clearly stated. It should also be clear whether the p-values reported are raw, or after correction. Corrected p-values are often appropriate, but raw p-values should be available in the supporting materials so that others may perform their own corrections. In large scale data exploration studies (e.g. genome wide expression studies) a clear and complete description of the replication structure must be provided. 

\subsection{Data Availability}

At the end of the Materials and Methods section, include a statement on reagent and data availability. Please read the Data and Reagent Policy before writing the statement. Make sure to list the accession numbers or DOIs of any data you have placed in public repositories. List the file names and descriptions of any data you will upload as supplemental information. The statement should also include any applicable IRB numbers. You may include specifications for how to properly acknowledge or cite the data.

For example: Strains are available upon request. File S1 contains detailed descriptions of all supplemental files. File S2 contains SNP ID numbers and locations. File S3 contains genotypes for each individual. Sequence data are available at GenBank and the accession numbers are listed in File S3. Gene expression data are available at GEO with the accession number: GDS1234. Code used to generate the simulated data is provided in file S4. 


\section{Results and Discussion}

The results and discussion should not be repetitive. The results section should give a factual presentation of the data and all tables and figures should be referenced; the discussion should not summarize the results but provide an interpretation of the results, and should clearly delineate between the findings of the particular study and the possible impact of those findings in a larger context. Authors are encouraged to cite recent work relevant to their interpretations. Present and discuss results only once, not in both the Results and Discussion sections. It is sometimes acceptable to combine results and discussion. The text should be as succinct as possible. Heed Strunk and White's dictum: "Omit needless words!"

\section{Additional guidelines}

\subsection{Numbers} In the text, write out numbers nine or less except as part of a date, a fraction or decimal, a percentage, or a unit of measurement. Use Arabic numbers for those larger than nine, except as the first word of a sentence; however, try to avoid starting a sentence with such a number.

\subsection{Units} Use abbreviations of the customary units of measurement only when they are preceded by a number: "3 min" but "several minutes". Write "percent" as one word, except when used with a number: "several percent" but "75\%." To indicate temperature in centigrade, use ° (for example, 37°); include a letter after the degree symbol only when some other scale is intended (for example, 45°K).

\subsection{Nomenclature and Italicization} Italicize names of organisms even when  when the species is not indicated.  Italicize the first three letters of the names of restriction enzyme cleavage sites, as in HindIII. Write the names of strains in roman except when incorporating specific genotypic designations. Italicize genotype names and symbols, including all components of alleles, but not when the name of a gene is the same as the name of an enzyme. Do not use "+" to indicate wild type. Carefully distinguish between genotype (italicized) and phenotype (not italicized) in both the writing and the symbolism.

\subsection{Cross References}
Use the \verb|\nameref| command with the \verb|\label| command to insert cross-references to section headings. For example, a \verb|\label| has been defined in the section \nameref{sec:materials:methods}.

\section{In-text Citations}

Add citations using the \verb|\citep{}| command, for example \citep{neher2013genealogies} or for multiple citations, \citep{neher2013genealogies, rodelsperger2014characterization,Falush16}

\section{Examples of Article Components}
\label{sec:examples}

The sections below show examples of different header levels, which you can use in the primary sections of the manuscript (Results, Discussion, etc.) to organize your content.

\section{First level section header}

Use this level to group two or more closely related headings in a long article.

\subsection{Second level section header}

Second level section text.

\subsubsection{Third level section header:}

Third level section text. These headings may be numbered, but only when the numbers must be cited in the text. 

\section{Figures and Tables}

Figures and Tables should be labelled and referenced in the standard way using the \verb|\label{}| and \verb|\ref{}| commands.

\subsection{Sample Figure}

Figure \ref{fig:spectrum} shows an example figure.

\begin{figure}[htbp!]
\centering
\includegraphics[width=\linewidth]{example-figure}
\caption{Example figure from \url{10.1534/genetics.114.173807}. Please include your figures in the manuscript for the review process. You can upload figures to Overleaf via the Project menu. Upon acceptance, we'll ask for your figure files to be uploaded in any of the following formats: TIFF (.tiff), JPEG (.jpg), Microsoft PowerPoint (.ppt), EPS (.eps), or Adobe Illustrator (.ai).  Images should be a minimum of 300 dpi in resolution and 500 dpi minimum if line art images.  RGB, CMYK, and Grayscale are all acceptable. Halftones should be high contrast with sharp detail, because some loss of detail and contrast is inevitable in the production process. Figures should be 10-20 cm in width and 1-25 cm in height. Graph axes must be exactly perpendicular and all lines of equal density.
Label multiple figure parts with A, B, etc. in bolded type, and use Arrows and numbers to draw attention to areas you want to highlight. Legends should start with a brief title and should be a self-contained description of the content of the figure that provides enough detail to fully understand the data presented. All conventional symbols used to indicate figure data points are available for typesetting; unconventional symbols should not be used. Italicize all mathematical variables (both in the figure legend and figure) , genotypes, and additional symbols that are normally italicized.  
}%
\label{fig:spectrum}
\end{figure}

\subsection{Sample Video}

Figure \ref{video:spectrum} shows how to include a video in your manuscript.

\begin{figure}[htbp]
\centering
\includegraphics[width=\linewidth]{example-figure}
\caption{Example movie (the figure file above is used as a placeholder for this example). \textit{GENETICS} supports video and movie files that can be linked from any portion of the article - including the abstract. Acceptable formats include .asf, avi, .wav, and all types of Windows Media files.   
}%
\label{video:spectrum}
\end{figure}


\subsection{Sample Table}

Table \ref{tab:shape-functions} shows an example table. Avoid shading, color type, line drawings, graphics, or other illustrations within tables. Use tables for data only; present drawings, graphics, and illustrations as separate figures. Histograms should not be used to present data that can be captured easily in text or small tables, as they take up much more space.  

Tables numbers are given in Arabic numerals. Tables should not be numbered 1A, 1B, etc., but if necessary, interior parts of the table can be labeled A, B, etc. for easy reference in the text.  


\begin{table*}[htbp]
\centering
\caption{\bf Students and their grades}
\begin{tableminipage}{\textwidth}
\begin{tabularx}{\textwidth}{XXXX}
\hline
Student & Grade\footnote{This is an example of a footnote in a table. Lowercase, superscript italic letters (a, b, c, etc.) are used by default. You can also use *, **, and *** to indicate conventional levels of statistical significance, explained below the table.} & Rank & Notes \\
\hline
Alice & 82\% & 1 & Performed very well.\\
Bob & 65\% & 3 & Not up to his usual standard.\\
Charlie & 73\% & 2 & A good attempt.\\
\hline
\end{tabularx}
  \label{tab:shape-functions}
\end{tableminipage}
\end{table*}

\section{Sample Equation}

Let $X_1, X_2, \ldots, X_n$ be a sequence of independent and identically distributed random variables with $\text{E}[X_i] = \mu$ and $\text{Var}[X_i] = \sigma^2 < \infty$, and let
\begin{equation}
S_n = \frac{X_1 + X_2 + \cdots + X_n}{n}
      = \frac{1}{n}\sum_{i}^{n} X_i
\label{eq:refname1}
\end{equation}
denote their mean. Then as $n$ approaches infinity, the random variables $\sqrt{n}(S_n - \mu)$ converge in distribution to a normal $\mathcal{N}(0, \sigma^2)$.
